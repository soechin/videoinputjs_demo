!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var i=e();for(var s in i)("object"==typeof exports?exports:t)[s]=i[s]}}(self,(function(){return function(){"use strict";var t={d:function(e,i){for(var s in i)t.o(i,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:i[s]})},o:function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r:function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};function i(t,e,i){if(!e.has(t))throw new TypeError("attempted to "+i+" private field on non-instance");return e.get(t)}function s(t,e,s){return function(t,e,i){if(e.set)e.set.call(t,i);else{if(!e.writable)throw new TypeError("attempted to set read only private field");e.value=i}}(t,i(t,e,"set"),s),s}function h(t,e){return function(t,e){return e.get?e.get.call(t):e.value}(t,i(t,e,"get"))}function n(t,e){o(t,e),e.add(t)}function a(t,e,i){o(t,e),e.set(t,i)}function o(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}function r(t,e,i){if(!e.has(t))throw new TypeError("attempted to get private field on non-instance");return i}t.r(e),t.d(e,{VideoInput:function(){return Q}});var l=new WeakMap,c=new WeakMap,d=new WeakMap,u=new WeakMap,w=new WeakMap,v=new WeakMap,f=new WeakMap,g=new WeakMap,p=new WeakMap,y=new WeakMap,m=new WeakMap,b=new WeakMap,k=new WeakMap,M=new WeakMap,D=new WeakMap,x=new WeakMap,W=new WeakSet,E=new WeakSet,j=new WeakSet,C=new WeakSet,P=new WeakSet,S=new WeakSet,I=new WeakSet,T=new WeakSet,F=new WeakSet;class Q{constructor(){n(this,F),n(this,T),n(this,I),n(this,S),n(this,P),n(this,C),n(this,j),n(this,E),n(this,W),a(this,l,{writable:!0,value:void 0}),a(this,c,{writable:!0,value:void 0}),a(this,d,{writable:!0,value:void 0}),a(this,u,{writable:!0,value:void 0}),a(this,w,{writable:!0,value:void 0}),a(this,v,{writable:!0,value:void 0}),a(this,f,{writable:!0,value:void 0}),a(this,g,{writable:!0,value:[]}),a(this,p,{writable:!0,value:void 0}),a(this,y,{writable:!0,value:[]}),a(this,m,{writable:!0,value:void 0}),a(this,b,{writable:!0,value:void 0}),a(this,k,{writable:!0,value:void 0}),a(this,M,{writable:!0,value:0}),a(this,D,{writable:!0,value:{}}),a(this,x,{writable:!0,value:{colorMode:0,rotateAngle:0,jpegQuality:50}})}async initialize(t){if(!navigator.mediaDevices)return void r(this,W,O).call(this,t);if(h(this,k)||(s(this,k,new Worker("videoinput.worker.js")),h(this,k).onmessage=t=>r(this,T,U).call(this,t)),!t)throw new Error("div is ".concat(t));for(;t.firstChild;)t.removeChild(t.firstChild);s(this,d,document.createElement("div")),h(this,d).style.position="relative",h(this,d).style.width="100%",h(this,d).style.height="100%",t.appendChild(h(this,d)),s(this,c,document.createElement("video")),h(this,c).playsInline=!0,h(this,c).style.display="none",h(this,d).appendChild(h(this,c)),s(this,u,document.createElement("canvas")),h(this,u).style.position="absolute",h(this,u).style.left=0,h(this,u).style.top=0,h(this,u).style.width="100%",h(this,u).style.height="100%",h(this,u).style.objectFit="contain",h(this,d).appendChild(h(this,u)),s(this,w,document.createElement("canvas")),h(this,w).style.position="absolute",h(this,w).style.left=0,h(this,w).style.top=0,h(this,w).style.width="100%",h(this,w).style.height="100%",h(this,w).style.objectFit="contain",h(this,d).appendChild(h(this,w)),s(this,v,document.createElement("canvas"));await this.listDevice(),h(this,g).find((t=>!!t.name))||(await(async()=>{(await navigator.mediaDevices.getUserMedia({video:!0})).getTracks().forEach((t=>{t.stop()}))})(),await this.listDevice()),this.devices.length>0&&s(this,f,this.devices[0])}async listDevice(){if(h(this,l))return void r(this,E,A).call(this);s(this,g,[]);const t=await navigator.mediaDevices.enumerateDevices();for(let e=0;e<t.length;e++){const i=t[e];if("videoinput"==i.kind){if(!await r(this,I,R).call(this,"doFilter",i.label))continue;h(this,g).push({index:h(this,g).length,name:i.label,path:i.deviceId})}}}get device(){return h(this,f)}set device(t){if(!t)return void s(this,f,null);const e=t.index,i=t.name,n=t.path;let a=null;!a&&n&&(a=h(this,g).find((t=>t.path==n))),!a&&i&&(a=h(this,g).find((t=>t.name.indexOf(i)>=0))),!a&&e>=0&&e<h(this,g).length&&(a=h(this,g)[e]),s(this,f,a)}get devices(){return h(this,g)}get resolution(){return h(this,p)}set resolution(t){if(!t)return void s(this,p,null);const e=t.index,i=t.width,n=t.height;let a=null;!a&&i>0&&n>0&&(a=h(this,y).find((t=>t.width==i&&t.height==n)),a||(a=t)),!a&&e>=0&&e<=h(this,y).length&&(a=h(this,y)[e]),s(this,p,a)}get resolutions(){return h(this,y)}async openDevice(){if(h(this,l))return void r(this,j,V).call(this);if(!h(this,f))throw new Error("this.device is ".concat(h(this,f)));this.closeDevice();const t=h(this,f).path,e=h(this,p)?h(this,p).width:0,i=h(this,p)?h(this,p).height:0;s(this,m,await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:t},width:e>0?{exact:e}:void 0,height:i>0?{exact:i}:void 0}})),h(this,c).srcObject=h(this,m),await h(this,c).play();let n=0,a=0;const o=h(this,m).getVideoTracks();o.forEach((t=>{try{const e=t.getCapabilities(),i=e.width.max,s=e.height.max;i>=n&&s>=a&&(n=i,a=s)}catch(t){console.error(t)}})),s(this,y,[]);[{width:4656,height:3496},{width:4160,height:3120},{width:3264,height:2448},{width:2592,height:1944},{width:2048,height:1536},{width:1920,height:1080},{width:1600,height:1200},{width:1280,height:720},{width:1024,height:768},{width:640,height:480},{width:320,height:240}].forEach((t=>{t.width<=n&&t.height<=a&&h(this,y).push({index:h(this,y).length,width:t.width,height:t.height})}));let d=h(this,c).videoWidth,u=h(this,c).videoHeight;if(d<u){const t=d;d=u,u=t}s(this,p,h(this,y).find((t=>t.width==d&&t.height==u))),h(this,p)||s(this,p,{width:d,height:u});let w=0;o.forEach((t=>{try{const e=t.getSettings().frameRate;if(e>0)return void(w=e)}catch(t){console.error(t)}})),0==w&&(w=15),s(this,b,w),setTimeout((()=>{r(this,P,z).call(this)}),0)}closeDevice(){if(h(this,l))r(this,C,H).call(this);else{if(h(this,m)){h(this,m).getTracks().forEach((t=>{t.stop()})),s(this,m,null)}h(this,c)&&(h(this,c).srcObject=null)}}async takePicture(t){if(h(this,l))return r(this,F,_).call(this,t);if(!t)throw new Error("ext is ".concat(t));const e=h(this,v),i=h(this,c).videoWidth,s=h(this,c).videoHeight;e.width==i&&e.height==s||(e.width=i,e.height=s);const n=e.getContext("2d");n.drawImage(h(this,c),0,0);const a={width:i,height:s,buffer:n.getImageData(0,0,i,s).data.buffer,settings:h(this,x)};await r(this,I,R).call(this,"doProcess",a,[a.buffer]);return await r(this,I,R).call(this,"doGrab",t)}async convertPicture(t,e){const i={base64:t,ext:e};return t=await r(this,I,R).call(this,"doConvert",i)}get rotateAngle(){return h(this,x).rotateAngle}set rotateAngle(t){if(t=90*Math.round(t/90)%360,h(this,x).rotateAngle=t,h(this,l)){const e=h(this,l).getDeviceIndex();h(this,l).setDeviceRotate(e,t)}}get colorMode(){return h(this,x).colorMode}set colorMode(t){h(this,x).colorMode=t}get jpegQuality(){return h(this,x).jpegQuality}set jpegQuality(t){h(this,x).jpegQuality=t}}function O(t){if(!t)throw new Error("div is ".concat(t));for(;t.firstChild;)t.removeChild(t.firstChild);s(this,l,document.createElement("object")),h(this,l).classid="clsid:30516390-004f-40b9-9fc6-c9096b59262e",h(this,l).style.width="100%",h(this,l).style.height="100%",t.appendChild(h(this,l)),r(this,E,A).call(this),this.devices.length>0&&s(this,f,this.devices[0])}function A(){s(this,g,[]);const t=h(this,l).getDeviceCount();for(let e=0;e<t;e++){const t=h(this,l).getDeviceName(e),i=h(this,l).getDevicePath(e);h(this,g).push({index:h(this,g).length,name:t,path:i})}}function V(){if(!h(this,f))throw new Error("this.device is ".concat(h(this,f)));r(this,C,H).call(this);const t=h(this,f).index;if(!h(this,l).openDevice(t))throw new Error("openDevice");if(h(this,p)){const e=h(this,l).getDeviceFormatCount(t),i=h(this,p).index,s=h(this,p).width,n=h(this,p).height;i>=0&&i<=e?h(this,l).setDeviceFormatIndex(t,i):s>0&&n>0&&h(this,l).setDeviceFormat(t,s,n,"")}if(!h(this,l).startPlayDevice(t))throw new Error("startPlayDevice");s(this,y,[]);const e=h(this,l).getDeviceFormatIndex(t);let i=0,n=0;const a=h(this,l).getDeviceFormatCount(t);for(let s=0;s<a;s++){const a=h(this,l).getDeviceFormatName(t,s).match(/(\d+) x (\d+), (\w+)/);if(a){const t=parseInt(a[1]),o=parseInt(a[2]);h(this,y).find((e=>e.width==t&&e.height==o))||h(this,y).push({index:h(this,y).length,width:t,height:o}),e==s&&(i=t,n=o)}}s(this,p,h(this,y).find((t=>t.width==i&&t.height==n)))}function H(){const t=h(this,l).getDeviceIndex();h(this,l).stopPlayDevice(t),h(this,l).closeDevice(t)}function z(){const t=1e3/h(this,b);let e=performance.now(),i=0;const s=()=>{if(!h(this,m))return;if(h(this,c).getVideoPlaybackQuality){const t=h(this,c).getVideoPlaybackQuality().totalVideoFrames;if(t>0&&t<=i)return void setTimeout(s,1);i=t}r(this,S,N).call(this);const n=performance.now();e=Math.max(e+t,n+1),setTimeout(s,e-n)};s()}function N(){const t=h(this,x).rotateAngle,e=90==t||270==t,i=h(this,c).videoWidth,s=h(this,c).videoHeight,n=h(this,u),a=e?s:i,o=e?i:s;n.width==a&&n.height==o||(n.width=a,n.height=o);const r=n.getContext("2d");r.save(),r.translate(a/2,o/2),r.rotate(t*Math.PI/180),r.drawImage(h(this,c),-i/2,-s/2),r.restore()}async function R(t,e,i){return new Promise(((n,a)=>{var o;const r=s(this,M,(o=h(this,M),++o));h(this,D)[r]=t=>{n(t)};const l={command:t,serial:r,payload:e};h(this,k).postMessage(l,i)}))}function U(t){const e=t.data,i=h(this,D)[e.serial];i&&i(e.payload),delete h(this,D)[e.serial]}function _(t){if(!t)throw new Error("ext is ".concat(t));h(this,l).setColorMode(h(this,x).colorMode),h(this,l).setJpegQuality(h(this,x).jpegQuality/100);return h(this,l).grabToBase64(t)}return e}()}));
//# sourceMappingURL=videoinput.js.map